<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DB운영 - 피드백 관리</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <style>
    /* 컨테이너 및 기본 폰트/밀집 스타일 (컴팩트) */
    body { font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; font-size:12px; }
    .container-1200 { max-width:1200px; margin-left:auto; margin-right:auto; }
    /* 카드·리스트 컴팩트화 */
    .compact-card .p-6 { padding:0.75rem; }
    .compact-card .p-4 { padding:0.5rem; }
    .compact-card .text-2xl { font-size:1rem; }
    .compact-card .text-lg { font-size:0.95rem; }
    .compact-card .text-sm { font-size:12px; }
    .compact-card .text-xs { font-size:11px; }
    .compact-card .w-10 { width:2rem; height:2rem; }
    .compact-card .w-5 { width:1rem; height:1rem; }
    .compact-card .p-3 { padding:0.5rem; }
    .compact-card .rounded-lg { border-radius:6px; }
    /* 카드 내부 최대 폭 제한(테이블처럼 보이게) */
    .card-inner { max-width:1200px; }
    .truncate-ellipsis { overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  </style>
</head>
<body class="min-h-screen bg-gray-50 p-6">
  <div class="container-1200">
    <!-- 헤더 -->
    <div class="bg-white rounded-lg shadow-sm p-4 mb-4 compact-card">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-lg font-bold text-gray-900">DB운영 - 피드백 관리</h1>
          <p class="text-xs text-gray-600 mt-1">미흡사항 → 피드백 → 개선사항의 전체 흐름</p>
        </div>
        <div class="flex gap-2">
          <button class="px-3 py-1.5 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-colors text-xs font-medium">
            필터
          </button>
          <button class="px-3 py-1.5 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors text-xs font-medium">
            검색
          </button>
        </div>
      </div>
    </div>

    <!-- 통계 -->
    <div class="grid grid-cols-4 gap-3 mb-4 compact-card">
      <div class="bg-white rounded-lg shadow-sm p-3 border-l-4 border-gray-400">
        <div class="text-xs text-gray-600 mb-1">전체</div>
        <div class="text-lg font-bold text-gray-900">107건</div>
      </div>
      <div class="bg-orange-50 rounded-lg shadow-sm p-3 border-l-4 border-orange-500">
        <div class="text-xs text-orange-700 mb-1">답변 대기</div>
        <div class="text-lg font-bold text-orange-900">2건</div>
      </div>
      <div class="bg-blue-50 rounded-lg shadow-sm p-3 border-l-4 border-blue-500">
        <div class="text-xs text-blue-700 mb-1">처리중</div>
        <div class="text-lg font-bold text-blue-900">2건</div>
      </div>
      <div class="bg-green-50 rounded-lg shadow-sm p-3 border-l-4 border-green-500">
        <div class="text-xs text-green-700 mb-1">완료</div>
        <div class="text-lg font-bold text-green-900">103건</div>
      </div>
    </div>

    <!-- 체크리스트 카드 목록 -->
    <div id="checklist-container" class="space-y-4">
      <!-- 동적으로 생성될 카드들 -->
    </div>

    <!-- 페이지네이션 -->
    <div class="mt-6 flex items-center justify-center gap-2">
      <button class="px-3 py-2 border border-gray-300 rounded hover:bg-gray-50 text-sm">«</button>
      <button class="px-3 py-2 border border-gray-300 rounded hover:bg-gray-50 text-sm">&lt;</button>
      <button class="px-3 py-2 bg-blue-600 text-white rounded text-sm font-medium">1</button>
      <button class="px-3 py-2 border border-gray-300 rounded hover:bg-gray-50 text-sm">2</button>
      <button class="px-3 py-2 border border-gray-300 rounded hover:bg-gray-50 text-sm">3</button>
      <button class="px-3 py-2 border border-gray-300 rounded hover:bg-gray-50 text-sm">&gt;</button>
      <button class="px-3 py-2 border border-gray-300 rounded hover:bg-gray-50 text-sm">»</button>
    </div>
  </div>

  <script>
    // 샘플 데이터
    const checklistData = [
      {
        id: 107,
        yearMonth: '2025/11',
        order: 7,
        category: '폴소평(상등)',
        title: '2025년 11월 소호엔티 (삼성화재 마이홈스크린특) DB 사후작 모집(관급)',
        person: '가은지진 홍길동 지장',
        status: 'feedback_pending',
        dueDate: '2025/10/21',
        thread: [
          {
            type: 'issue',
            author: '시스템',
            role: '자동 감지',
            date: '2025/05/12 09:00:00',
            content: '위해측기술을 제대로 인내하지 않습니다.',
            badge: '미흡사항'
          },
          {
            type: 'feedback',
            author: '김세현',
            role: '차장 (승인자)',
            date: '2025/05/13 10:05:12',
            content: '신규 허용시 보험설계사의 면담을 확인하고 있는가?\n\n해당 항목에 대한 추가 검토가 필요합니다. 면담 기록이 시스템에 등록되어 있는지 확인해주세요.',
            badge: '피드백'
          }
        ]
      },
      {
        id: 106,
        yearMonth: '2025/11',
        order: 6,
        category: '보장분석 미래',
        title: '2025년 11월 온라인이(보장분석) 모집(관급)',
        person: '이영희 대리',
        status: 'in_progress',
        dueDate: '2025/10/21',
        thread: [
          {
            type: 'issue',
            author: '시스템',
            role: '자동 감지',
            date: '2025/05/12 14:20:00',
            content: '보장분석 정확성 확인 필요',
            badge: '미흡사항'
          },
          {
            type: 'feedback',
            author: '박준서',
            role: '부장 (승인자)',
            date: '2025/05/13 09:30:45',
            content: '보장분석 프로세스의 정확성을 개선해주세요.\n\n특히 고객별 맞춤 분석 부분에서 오류가 발견되었습니다.',
            badge: '피드백'
          },
          {
            type: 'improvement',
            author: '이영희',
            role: '대리 (담당자)',
            date: '2025/05/14 16:20:00',
            content: '고객 보장분석 시 3단계 검증 프로세스를 도입하겠습니다.\n\n1단계: 기본 정보 확인\n2단계: 보장 내역 교차 검증\n3단계: 최종 승인자 확인',
            completionDate: '2025/05/20',
            badge: '개선사항'
          }
        ]
      },
      {
        id: 105,
        yearMonth: '2025/11',
        order: 5,
        category: '파미선_설비_영지AS',
        title: '2025년 11월 파미선_설비_영지AS DB 모집(관급)',
        person: '최민수 과장',
        status: 'completed',
        dueDate: '2025/10/21',
        thread: [
          {
            type: 'issue',
            author: '시스템',
            role: '자동 감지',
            date: '2025/05/11 10:00:00',
            content: 'AS 응대 프로세스 점검 필요',
            badge: '미흡사항'
          },
          {
            type: 'feedback',
            author: '정해인',
            role: '이사 (승인자)',
            date: '2025/05/12 14:20:30',
            content: 'AS 응대 프로세스 개선이 필요합니다.\n\n고객 응대 시간이 평균 48시간으로 너무 깁니다.',
            badge: '피드백'
          },
          {
            type: 'improvement',
            author: '최민수',
            role: '과장 (담당자)',
            date: '2025/05/13 11:00:00',
            content: 'AS 요청 접수 후 24시간 내 1차 응대 완료 프로세스를 구축하였습니다.\n\n- 즉시 접수 시스템 구축\n- 담당자 자동 배정\n- 알림톡 자동 발송',
            completionDate: '2025/05/18',
            badge: '개선사항'
          },
          {
            type: 'approval',
            author: '정해인',
            role: '이사 (승인자)',
            date: '2025/05/18 15:30:00',
            content: '개선사항 확인 완료했습니다. 승인합니다. 수고하셨습니다.',
            badge: '승인완료'
          }
        ]
      },
      {
        id: 104,
        yearMonth: '2025/11',
        order: 4,
        category: '파미선_보_시AS',
        title: '2025년 11월 파미선_보_시AS DB 사후작 모집(관급)',
        person: '강서연 사원',
        status: 'feedback_pending',
        dueDate: '2025/10/21',
        thread: [
          {
            type: 'issue',
            author: '시스템',
            role: '자동 감지',
            date: '2025/05/13 08:00:00',
            content: '보험설계사 경력 확인 누락',
            badge: '미흡사항'
          },
          {
            type: 'feedback',
            author: '최동욱',
            role: '차장 (승인자)',
            date: '2025/05/14 10:15:22',
            content: '파미선 보험설계사에 총 10년 이상 보험영업을 하고 있지 않은 보험설계사가 있는가?\n\n경력 확인 절차를 다시 점검해주세요.',
            badge: '피드백'
          }
        ]
      }
    ];

    // 상태 설정
    const getStatusConfig = (status) => {
      const configs = {
        feedback_pending: {
          label: '답변 대기',
          color: 'bg-orange-100 text-orange-700 border-orange-300',
          icon: 'clock'
        },
        in_progress: {
          label: '처리중',
          color: 'bg-blue-100 text-blue-700 border-blue-300',
          icon: 'message-square'
        },
        completed: {
          label: '완료',
          color: 'bg-green-100 text-green-700 border-green-300',
          icon: 'check-circle-2'
        }
      };
      return configs[status] || configs.feedback_pending;
    };

    const getBadgeStyle = (type) => {
      const styles = {
        issue: 'bg-gray-100 text-gray-700 border-gray-300',
        feedback: 'bg-orange-100 text-orange-700 border-orange-300',
        improvement: 'bg-blue-100 text-blue-700 border-blue-300',
        approval: 'bg-green-100 text-green-700 border-green-300'
      };
      return styles[type] || styles.issue;
    };

    // 아이콘 생성 함수
    const createIcon = (iconName, className = 'w-5 h-5') => {
      const icon = document.createElement('i');
      icon.setAttribute('data-lucide', iconName);
      icon.className = className;
      return icon;
    };

    // 스레드 메시지 생성
    const createThreadMessage = (message, isLast) => {
      const isSystemMessage = message.type === 'issue';
      const isFeedback = message.type === 'feedback';
      const isImprovement = message.type === 'improvement';
      const isApproval = message.type === 'approval';

      const messageDiv = document.createElement('div');
  messageDiv.className = `flex gap-3 ${!isLast ? 'pb-3' : ''} text-sm`;

      // 타임라인 라인
      const timelineDiv = document.createElement('div');
      timelineDiv.className = 'flex flex-col items-center';

      const iconContainer = document.createElement('div');
  iconContainer.className = `w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 ${
        isSystemMessage ? 'bg-gray-100 border-2 border-gray-300' :
        isFeedback ? 'bg-orange-100 border-2 border-orange-400' :
        isImprovement ? 'bg-blue-100 border-2 border-blue-400' :
        'bg-green-100 border-2 border-green-400'
      }`;

      let icon;
      if (isSystemMessage) icon = createIcon('alert-circle', 'w-5 h-5 text-gray-600');
      else if (isFeedback) icon = createIcon('message-square', 'w-5 h-5 text-orange-600');
      else if (isImprovement) icon = createIcon('send', 'w-5 h-5 text-blue-600');
      else icon = createIcon('check-circle-2', 'w-5 h-5 text-green-600');

      iconContainer.appendChild(icon);

      if (!isLast) {
        const line = document.createElement('div');
        line.className = `w-0.5 flex-1 mt-2 ${
          isFeedback ? 'bg-orange-200' :
          isImprovement ? 'bg-blue-200' :
          isApproval ? 'bg-green-200' :
          'bg-gray-200'
        }`;
        line.style.minHeight = '20px';
        timelineDiv.appendChild(iconContainer);
        timelineDiv.appendChild(line);
      } else {
        timelineDiv.appendChild(iconContainer);
      }

      // 메시지 내용
  const contentDiv = document.createElement('div');
  contentDiv.className = 'flex-1 min-w-0 text-sm';

      const headerDiv = document.createElement('div');
  headerDiv.className = 'flex items-center gap-2 mb-1 text-xs';

      const badge = document.createElement('span');
  badge.className = `text-xs font-semibold px-2 py-0.5 rounded-full border ${getBadgeStyle(message.type)}`;
      badge.textContent = message.badge;

      const author = document.createElement('span');
  author.className = 'text-sm font-semibold text-gray-900';
      author.textContent = message.author;

      const role = document.createElement('span');
      role.className = 'text-xs text-gray-500';
      role.textContent = message.role;

      const date = document.createElement('span');
      date.className = 'text-xs text-gray-400';
      date.textContent = message.date;

      headerDiv.appendChild(badge);
      headerDiv.appendChild(author);
      headerDiv.appendChild(role);
      headerDiv.appendChild(date);

  const messageContent = document.createElement('div');
  messageContent.className = `p-2 rounded-lg border ${
        isSystemMessage ? 'bg-gray-50 border-gray-200' :
        isFeedback ? 'bg-orange-50 border-orange-200' :
        isImprovement ? 'bg-blue-50 border-blue-200' :
        'bg-green-50 border-green-200'
      }`;

  const contentText = document.createElement('p');
  contentText.className = 'text-xs text-gray-800 whitespace-pre-line leading-relaxed';
      contentText.textContent = message.content;

      messageContent.appendChild(contentText);

      if (message.completionDate) {
  const completionDiv = document.createElement('div');
  completionDiv.className = 'mt-2 pt-2 border-t border-blue-200 flex items-center gap-2 text-xs';

  const calendarIcon = createIcon('calendar', 'w-4 h-4 text-blue-600');
  const completionText = document.createElement('span');
  completionText.className = 'text-xs font-medium text-blue-900';
  completionText.textContent = `완료 예정일: ${message.completionDate}`;

        completionDiv.appendChild(calendarIcon);
        completionDiv.appendChild(completionText);
        messageContent.appendChild(completionDiv);
      }

      contentDiv.appendChild(headerDiv);
      contentDiv.appendChild(messageContent);

      messageDiv.appendChild(timelineDiv);
      messageDiv.appendChild(contentDiv);

      return messageDiv;
    };

    // 카드 생성
    const createCard = (item) => {
      const card = document.createElement('div');
      const statusConfig = getStatusConfig(item.status);
      const lastMessage = item.thread[item.thread.length - 1];
      const needsReply = lastMessage.type === 'feedback';

      card.className = `bg-white rounded-lg shadow-sm border-2 transition-all ${
        needsReply ? 'border-orange-300 shadow-orange-100' : 'border-gray-200'
      }`;
      card.setAttribute('data-id', item.id);

      // 카드 헤더
      const header = document.createElement('div');
      header.className = 'p-4 cursor-pointer hover:bg-gray-50 transition-colors';
      header.addEventListener('click', () => toggleThread(item.id));

      const headerContent = document.createElement('div');
      headerContent.className = 'flex items-start justify-between';

      const leftDiv = document.createElement('div');
      leftDiv.className = 'flex-1 min-w-0';

      const titleRow = document.createElement('div');
      titleRow.className = 'flex items-center gap-3 mb-2';

  const idSpan = document.createElement('span');
  idSpan.className = 'text-sm font-bold text-gray-900';
      idSpan.textContent = `#${item.id}`;

  const statusSpan = document.createElement('span');
  statusSpan.className = `inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-semibold border ${statusConfig.color}`;
      
      const statusIcon = createIcon(statusConfig.icon, 'w-4 h-4');
      statusSpan.appendChild(statusIcon);
      statusSpan.appendChild(document.createTextNode(statusConfig.label));

  const categorySpan = document.createElement('span');
  categorySpan.className = 'text-xs text-gray-500';
      categorySpan.textContent = item.category;

      titleRow.appendChild(idSpan);
      titleRow.appendChild(statusSpan);
      titleRow.appendChild(categorySpan);

      if (needsReply) {
        const alertSpan = document.createElement('span');
        alertSpan.className = 'inline-flex items-center gap-1 px-2 py-1 bg-orange-100 text-orange-700 rounded-full text-xs font-medium animate-pulse';
        
        const alertIcon = createIcon('alert-circle', 'w-3 h-3');
        alertSpan.appendChild(alertIcon);
        alertSpan.appendChild(document.createTextNode('답변 필요'));
        
        titleRow.appendChild(alertSpan);
      }

  const title = document.createElement('h3');
  title.className = 'text-sm font-medium text-gray-900 mb-1 truncate-ellipsis';
      title.textContent = item.title;

  const metaDiv = document.createElement('div');
  metaDiv.className = 'flex items-center gap-3 text-xs text-gray-600';
      metaDiv.innerHTML = `
        <span>담당: ${item.person}</span>
        <span>•</span>
        <span>기한: ${item.dueDate}</span>
        <span>•</span>
        <span>${item.thread.length}개 메시지</span>
      `;

      leftDiv.appendChild(titleRow);
      leftDiv.appendChild(title);
      leftDiv.appendChild(metaDiv);

      const rightDiv = document.createElement('div');
      rightDiv.className = 'ml-4';

      const chevronIcon = createIcon('chevron-down', 'w-5 h-5 text-gray-400');
      chevronIcon.setAttribute('data-chevron', item.id);
      rightDiv.appendChild(chevronIcon);

      headerContent.appendChild(leftDiv);
      headerContent.appendChild(rightDiv);

      // 미리보기
      const preview = document.createElement('div');
  preview.className = 'mt-2 pt-2 border-t border-gray-100';
      preview.setAttribute('data-preview', item.id);

      const previewContent = document.createElement('div');
  previewContent.className = 'flex items-center gap-2 text-xs text-gray-600';

      const previewBadge = document.createElement('span');
  previewBadge.className = `px-2 py-0.5 rounded border text-xs ${getBadgeStyle(lastMessage.type)}`;
      previewBadge.textContent = lastMessage.badge;

      const previewAuthor = document.createElement('span');
      previewAuthor.className = 'font-medium';
      previewAuthor.textContent = lastMessage.author;

      const previewText = document.createElement('span');
      previewText.className = 'truncate';
      previewText.textContent = lastMessage.content.substring(0, 50) + '...';

      previewContent.appendChild(previewBadge);
      previewContent.appendChild(previewAuthor);
      previewContent.appendChild(document.createTextNode(' - '));
      previewContent.appendChild(previewText);

      preview.appendChild(previewContent);

      header.appendChild(headerContent);
      header.appendChild(preview);

      // 스레드 확장 영역
      const threadArea = document.createElement('div');
      threadArea.className = 'border-t border-gray-200 bg-gradient-to-b from-gray-50 to-white hidden';
      threadArea.setAttribute('data-thread', item.id);

      const threadContent = document.createElement('div');
      threadContent.className = 'p-6';

      const threadContainer = document.createElement('div');
      threadContainer.className = 'max-w-4xl';

      // 기존 메시지들
      item.thread.forEach((message, index) => {
        const isLast = index === item.thread.length - 1;
        const messageElement = createThreadMessage(message, isLast);
        threadContainer.appendChild(messageElement);
      });

      // 답변 입력 영역
      const replyArea = document.createElement('div');
      replyArea.className = '';
      replyArea.setAttribute('data-reply', item.id);

      // 답변이 필요한 경우 (피드백만 있고 개선사항이 없는 경우)
      if (needsReply) {
        const replyButton = document.createElement('div');
        replyButton.className = 'flex gap-3';

        const replyTimeline = document.createElement('div');
        replyTimeline.className = 'flex flex-col items-center';

        const replyIconContainer = document.createElement('div');
        replyIconContainer.className = 'w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 bg-blue-50 border-2 border-dashed border-blue-300';

        const plusIcon = createIcon('plus', 'w-5 h-5 text-blue-400');
        replyIconContainer.appendChild(plusIcon);
        replyTimeline.appendChild(replyIconContainer);

        const replyButtonDiv = document.createElement('div');
        replyButtonDiv.className = 'flex-1';

        const button = document.createElement('button');
        button.className = 'w-full border-2 border-dashed border-blue-300 rounded-lg p-4 text-sm text-blue-600 hover:bg-blue-50 transition-colors font-medium flex items-center justify-center gap-2';
        button.addEventListener('click', () => showReplyForm(item.id));

        const sendIcon = createIcon('send', 'w-4 h-4');
        button.appendChild(sendIcon);
        button.appendChild(document.createTextNode('개선사항 작성하기'));

        replyButtonDiv.appendChild(button);
        replyButton.appendChild(replyTimeline);
        replyButton.appendChild(replyButtonDiv);

        replyArea.appendChild(replyButton);
      }

      // 개선사항이 있고 승인이 필요한 경우
      const hasImprovement = item.thread.some(msg => msg.type === 'improvement');
      const hasApproval = item.thread.some(msg => msg.type === 'approval');
      
      if (hasImprovement && !hasApproval && item.status === 'in_progress') {
        const approvalArea = document.createElement('div');
        approvalArea.className = 'flex gap-3 mt-4';

        const approvalTimeline = document.createElement('div');
        approvalTimeline.className = 'flex flex-col items-center';

        const approvalIconContainer = document.createElement('div');
        approvalIconContainer.className = 'w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 bg-green-50 border-2 border-dashed border-green-300';

        const checkIcon = createIcon('check-circle', 'w-5 h-5 text-green-400');
        approvalIconContainer.appendChild(checkIcon);
        approvalTimeline.appendChild(approvalIconContainer);

        const approvalButtonDiv = document.createElement('div');
        approvalButtonDiv.className = 'flex-1';

        const approvalButton = document.createElement('button');
        approvalButton.className = 'w-full border-2 border-dashed border-green-300 rounded-lg p-4 text-sm text-green-600 hover:bg-green-50 transition-colors font-medium flex items-center justify-center gap-2';
        approvalButton.addEventListener('click', () => showApprovalForm(item.id));

        const approveIcon = createIcon('check-circle', 'w-4 h-4');
        approvalButton.appendChild(approveIcon);
        approvalButton.appendChild(document.createTextNode('개선사항 승인하기'));

        approvalButtonDiv.appendChild(approvalButton);
        approvalArea.appendChild(approvalTimeline);
        approvalArea.appendChild(approvalButtonDiv);

        replyArea.appendChild(approvalArea);
      }

      threadContainer.appendChild(replyArea);
      threadContent.appendChild(threadContainer);
      threadArea.appendChild(threadContent);

      card.appendChild(header);
      card.appendChild(threadArea);

      return card;
    };

    // 답변 폼 생성
    const createReplyForm = (item) => {
      const formDiv = document.createElement('div');
      formDiv.className = 'flex gap-3';

      const timeline = document.createElement('div');
      timeline.className = 'flex flex-col items-center';

      const iconContainer = document.createElement('div');
      iconContainer.className = 'w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 bg-blue-100 border-2 border-blue-400';

      const sendIcon = createIcon('send', 'w-5 h-5 text-blue-600');
      iconContainer.appendChild(sendIcon);
      timeline.appendChild(iconContainer);

      const formContainer = document.createElement('div');
      formContainer.className = 'flex-1';

      const header = document.createElement('div');
      header.className = 'flex items-center gap-2 mb-2';

      const badge = document.createElement('span');
      badge.className = 'text-xs font-semibold px-2 py-0.5 rounded-full border bg-blue-100 text-blue-700 border-blue-300';
      badge.textContent = '개선사항';

      const author = document.createElement('span');
      author.className = 'text-sm font-semibold text-gray-900';
      author.textContent = item.person;

      const role = document.createElement('span');
      role.className = 'text-xs text-gray-500';
      role.textContent = '(담당자)';

      header.appendChild(badge);
      header.appendChild(author);
      header.appendChild(role);

      const form = document.createElement('div');
      form.className = 'space-y-3';

      const textarea = document.createElement('textarea');
      textarea.className = 'w-full border-2 border-blue-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none';
      textarea.rows = 5;
      textarea.placeholder = '개선사항을 구체적으로 작성해주세요...\n\n• 현재 상황 분석\n• 구체적인 개선 방안\n• 실행 일정';
      textarea.setAttribute('data-reply-text', item.id);

      const dateContainer = document.createElement('div');
      dateContainer.className = 'flex items-center gap-3';

      const dateLabel = document.createElement('div');
      dateLabel.className = 'flex items-center gap-2';

      const calendarIcon = createIcon('calendar', 'w-4 h-4 text-gray-500');
      const label = document.createElement('label');
      label.className = 'text-sm font-medium text-gray-700';
      label.textContent = '완료 예정일:';

      const dateInput = document.createElement('input');
      dateInput.type = 'date';
      dateInput.className = 'border border-gray-300 rounded px-3 py-1.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent';
      dateInput.setAttribute('data-reply-date', item.id);

      dateLabel.appendChild(calendarIcon);
      dateLabel.appendChild(label);
      dateLabel.appendChild(dateInput);
      dateContainer.appendChild(dateLabel);

      const buttonContainer = document.createElement('div');
      buttonContainer.className = 'flex gap-2';

      const submitButton = document.createElement('button');
      submitButton.className = 'flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium';
      submitButton.addEventListener('click', () => submitReply(item.id));

      const submitIcon = createIcon('send', 'w-4 h-4');
      submitButton.appendChild(submitIcon);
      submitButton.appendChild(document.createTextNode('개선사항 제출'));

      const cancelButton = document.createElement('button');
      cancelButton.className = 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors text-sm font-medium';
      cancelButton.textContent = '취소';
      cancelButton.addEventListener('click', () => hideReplyForm(item.id));

      buttonContainer.appendChild(submitButton);
      buttonContainer.appendChild(cancelButton);

      form.appendChild(textarea);
      form.appendChild(dateContainer);
      form.appendChild(buttonContainer);

      formContainer.appendChild(header);
      formContainer.appendChild(form);

      formDiv.appendChild(timeline);
      formDiv.appendChild(formContainer);

      return formDiv;
    };

    // 승인 폼 생성
    const createApprovalForm = (item) => {
      const formDiv = document.createElement('div');
      formDiv.className = 'flex gap-3';

      const timeline = document.createElement('div');
      timeline.className = 'flex flex-col items-center';

      const iconContainer = document.createElement('div');
      iconContainer.className = 'w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 bg-green-100 border-2 border-green-400';

      const checkIcon = createIcon('check-circle', 'w-5 h-5 text-green-600');
      iconContainer.appendChild(checkIcon);
      timeline.appendChild(iconContainer);

      const formContainer = document.createElement('div');
      formContainer.className = 'flex-1';

      const header = document.createElement('div');
      header.className = 'flex items-center gap-2 mb-2';

      const badge = document.createElement('span');
      badge.className = 'text-xs font-semibold px-2 py-0.5 rounded-full border bg-green-100 text-green-700 border-green-300';
      badge.textContent = '승인';

      const author = document.createElement('span');
      author.className = 'text-sm font-semibold text-gray-900';
      author.textContent = '승인자';

      const role = document.createElement('span');
      role.className = 'text-xs text-gray-500';
      role.textContent = '(관리자)';

      header.appendChild(badge);
      header.appendChild(author);
      header.appendChild(role);

      const form = document.createElement('div');
      form.className = 'space-y-3';

      const textarea = document.createElement('textarea');
      textarea.className = 'w-full border-2 border-green-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-green-500 focus:border-transparent resize-none';
      textarea.rows = 4;
      textarea.placeholder = '승인 의견을 작성해주세요...\n\n• 개선사항 검토 결과\n• 추가 요청사항\n• 기타 의견';
      textarea.setAttribute('data-approval-text', item.id);

      const buttonContainer = document.createElement('div');
      buttonContainer.className = 'flex gap-2';

      const approveButton = document.createElement('button');
      approveButton.className = 'flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm font-medium';
      approveButton.addEventListener('click', () => submitApproval(item.id));

      const approveIcon = createIcon('check-circle', 'w-4 h-4');
      approveButton.appendChild(approveIcon);
      approveButton.appendChild(document.createTextNode('승인 완료'));

      const cancelButton = document.createElement('button');
      cancelButton.className = 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors text-sm font-medium';
      cancelButton.textContent = '취소';
      cancelButton.addEventListener('click', () => hideReplyForm(item.id));

      buttonContainer.appendChild(approveButton);
      buttonContainer.appendChild(cancelButton);

      form.appendChild(textarea);
      form.appendChild(buttonContainer);

      formContainer.appendChild(header);
      formContainer.appendChild(form);

      formDiv.appendChild(timeline);
      formDiv.appendChild(formContainer);

      return formDiv;
    };

    // 전역 상태
    const expandedThreads = {};
    const replyingTo = {};

    // 스레드 토글
    const toggleThread = (id) => {
      const threadArea = document.querySelector(`[data-thread="${id}"]`);
      const preview = document.querySelector(`[data-preview="${id}"]`);
      const chevron = document.querySelector(`[data-chevron="${id}"]`);
      
      if (expandedThreads[id]) {
        threadArea.classList.add('hidden');
        preview.classList.remove('hidden');
        chevron.setAttribute('data-lucide', 'chevron-down');
        expandedThreads[id] = false;
      } else {
        threadArea.classList.remove('hidden');
        preview.classList.add('hidden');
        chevron.setAttribute('data-lucide', 'chevron-up');
        expandedThreads[id] = true;
      }
    };

    // 답변 폼 표시
    const showReplyForm = (id) => {
      const replyArea = document.querySelector(`[data-reply="${id}"]`);
      const item = checklistData.find(item => item.id === id);
      
      if (item && item.thread[item.thread.length - 1].type === 'feedback') {
        replyArea.innerHTML = '';
        replyArea.appendChild(createReplyForm(item));
        replyingTo[id] = true;
      }
    };

    // 승인 폼 표시
    const showApprovalForm = (id) => {
      const replyArea = document.querySelector(`[data-reply="${id}"]`);
      const item = checklistData.find(item => item.id === id);
      
      if (item) {
        replyArea.innerHTML = '';
        replyArea.appendChild(createApprovalForm(item));
        replyingTo[id] = true;
      }
    };

    // 답변 폼 숨기기
    const hideReplyForm = (id) => {
      const replyArea = document.querySelector(`[data-reply="${id}"]`);
      const item = checklistData.find(item => item.id === id);
      
      if (item) {
        // 원래 버튼들로 복원
        replyArea.innerHTML = '';
        
        // 답변이 필요한 경우
        const lastMessage = item.thread[item.thread.length - 1];
        const needsReply = lastMessage.type === 'feedback';
        
        if (needsReply) {
          const replyButton = document.createElement('div');
          replyButton.className = 'flex gap-3';

          const replyTimeline = document.createElement('div');
          replyTimeline.className = 'flex flex-col items-center';

          const replyIconContainer = document.createElement('div');
          replyIconContainer.className = 'w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 bg-blue-50 border-2 border-dashed border-blue-300';

          const plusIcon = createIcon('plus', 'w-5 h-5 text-blue-400');
          replyIconContainer.appendChild(plusIcon);
          replyTimeline.appendChild(replyIconContainer);

          const replyButtonDiv = document.createElement('div');
          replyButtonDiv.className = 'flex-1';

          const button = document.createElement('button');
          button.className = 'w-full border-2 border-dashed border-blue-300 rounded-lg p-4 text-sm text-blue-600 hover:bg-blue-50 transition-colors font-medium flex items-center justify-center gap-2';
          button.addEventListener('click', () => showReplyForm(item.id));

          const sendIcon = createIcon('send', 'w-4 h-4');
          button.appendChild(sendIcon);
          button.appendChild(document.createTextNode('개선사항 작성하기'));

          replyButtonDiv.appendChild(button);
          replyButton.appendChild(replyTimeline);
          replyButton.appendChild(replyButtonDiv);

          replyArea.appendChild(replyButton);
        }

        // 개선사항이 있고 승인이 필요한 경우
        const hasImprovement = item.thread.some(msg => msg.type === 'improvement');
        const hasApproval = item.thread.some(msg => msg.type === 'approval');
        
        if (hasImprovement && !hasApproval && item.status === 'in_progress') {
          const approvalArea = document.createElement('div');
          approvalArea.className = 'flex gap-3 mt-4';

          const approvalTimeline = document.createElement('div');
          approvalTimeline.className = 'flex flex-col items-center';

          const approvalIconContainer = document.createElement('div');
          approvalIconContainer.className = 'w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 bg-green-50 border-2 border-dashed border-green-300';

          const checkIcon = createIcon('check-circle', 'w-5 h-5 text-green-400');
          approvalIconContainer.appendChild(checkIcon);
          approvalTimeline.appendChild(approvalIconContainer);

          const approvalButtonDiv = document.createElement('div');
          approvalButtonDiv.className = 'flex-1';

          const approvalButton = document.createElement('button');
          approvalButton.className = 'w-full border-2 border-dashed border-green-300 rounded-lg p-4 text-sm text-green-600 hover:bg-green-50 transition-colors font-medium flex items-center justify-center gap-2';
          approvalButton.addEventListener('click', () => showApprovalForm(item.id));

          const approveIcon = createIcon('check-circle', 'w-4 h-4');
          approvalButton.appendChild(approveIcon);
          approvalButton.appendChild(document.createTextNode('개선사항 승인하기'));

          approvalButtonDiv.appendChild(approvalButton);
          approvalArea.appendChild(approvalTimeline);
          approvalArea.appendChild(approvalButtonDiv);

          replyArea.appendChild(approvalArea);
        }
        
        // Lucide 아이콘 다시 초기화
        lucide.createIcons();
      }
      
      replyingTo[id] = false;
    };

    // 답변 제출
    const submitReply = (id) => {
      const textarea = document.querySelector(`[data-reply-text="${id}"]`);
      const dateInput = document.querySelector(`[data-reply-date="${id}"]`);
      
      if (!textarea.value.trim()) {
        alert('개선사항을 입력하세요.');
        textarea.focus();
        return;
      }
      
      if (!dateInput.value) {
        alert('완료 예정일을 선택하세요.');
        dateInput.focus();
        return;
      }

      // 데이터에 개선사항 추가
      const item = checklistData.find(item => item.id === id);
      if (item) {
        const newImprovement = {
          type: 'improvement',
          author: item.person,
          role: '담당자',
          date: new Date().toLocaleString('ko-KR', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
          }).replace(/\./g, '/').replace(/,/g, ''),
          content: textarea.value.trim(),
          completionDate: dateInput.value,
          badge: '개선사항'
        };

        item.thread.push(newImprovement);
        
        // 상태 업데이트 (피드백 대기 → 처리중)
        if (item.status === 'feedback_pending') {
          item.status = 'in_progress';
        }

        // 카드 다시 렌더링
        refreshCard(id);
        
        // 통계 업데이트
        updateStatistics();
      }

      // 폼 숨기기
      hideReplyForm(id);
      
      // 입력 필드 초기화
      textarea.value = '';
      dateInput.value = '';

      // 성공 메시지
      showSuccessMessage('개선사항이 성공적으로 제출되었습니다.');
    };

    // 승인 제출
    const submitApproval = (id) => {
      const textarea = document.querySelector(`[data-approval-text="${id}"]`);
      
      if (!textarea.value.trim()) {
        alert('승인 의견을 입력하세요.');
        textarea.focus();
        return;
      }

      // 데이터에 승인 추가
      const item = checklistData.find(item => item.id === id);
      if (item) {
        const newApproval = {
          type: 'approval',
          author: '승인자',
          role: '관리자',
          date: new Date().toLocaleString('ko-KR', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
          }).replace(/\./g, '/').replace(/,/g, ''),
          content: textarea.value.trim(),
          badge: '승인완료'
        };

        item.thread.push(newApproval);
        
        // 상태 업데이트 (처리중 → 완료)
        item.status = 'completed';

        // 카드 다시 렌더링
        refreshCard(id);
        
        // 통계 업데이트
        updateStatistics();
      }

      // 폼 숨기기
      hideReplyForm(id);
      
      // 입력 필드 초기화
      textarea.value = '';

      // 성공 메시지
      showSuccessMessage('개선사항이 성공적으로 승인되었습니다.');
    };

    // 카드 새로고침
    const refreshCard = (id) => {
      const item = checklistData.find(item => item.id === id);
      if (item) {
        const existingCard = document.querySelector(`[data-id="${id}"]`);
        if (existingCard) {
          const newCard = createCard(item);
          existingCard.parentNode.replaceChild(newCard, existingCard);
          
          // Lucide 아이콘 다시 초기화
          lucide.createIcons();
        }
      }
    };

    // 통계 업데이트
    const updateStatistics = () => {
      const total = checklistData.length;
      const feedbackPending = checklistData.filter(item => item.status === 'feedback_pending').length;
      const inProgress = checklistData.filter(item => item.status === 'in_progress').length;
      const completed = checklistData.filter(item => item.status === 'completed').length;

      // 통계 카드 업데이트
      const statsCards = document.querySelectorAll('.grid.grid-cols-4.gap-4.mb-6 > div');
      if (statsCards.length >= 4) {
        statsCards[0].querySelector('.text-2xl').textContent = `${total}건`;
        statsCards[1].querySelector('.text-2xl').textContent = `${feedbackPending}건`;
        statsCards[2].querySelector('.text-2xl').textContent = `${inProgress}건`;
        statsCards[3].querySelector('.text-2xl').textContent = `${completed}건`;
      }
    };

    // 성공 메시지 표시
    const showSuccessMessage = (message) => {
      // 기존 메시지 제거
      const existingMessage = document.querySelector('.success-message');
      if (existingMessage) {
        existingMessage.remove();
      }

      const messageDiv = document.createElement('div');
      messageDiv.className = 'success-message fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center gap-2';
      
      const checkIcon = createIcon('check-circle', 'w-5 h-5');
      messageDiv.appendChild(checkIcon);
      messageDiv.appendChild(document.createTextNode(message));

      document.body.appendChild(messageDiv);

      // 3초 후 자동 제거
      setTimeout(() => {
        messageDiv.remove();
      }, 3000);
    };

    // 초기화
    document.addEventListener('DOMContentLoaded', () => {
      const container = document.getElementById('checklist-container');
      
      checklistData.forEach(item => {
        const card = createCard(item);
        container.appendChild(card);
      });

      // Lucide 아이콘 초기화
      lucide.createIcons();
    });
  </script>
</body>
</html>
